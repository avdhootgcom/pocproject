
@{
    ViewBag.Title = "Map";
}


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Display Visible Features</title>
</head>

<body>
    <div class="row">
        <br>
        <div class="col-lg-2">
            <label for="BlockNumber">Block Number:</label>
        </div>
        <div class="col-lg-3">
            <input type="number" class="form-control" required="required" id="getBlock">
        </div>
        <div class="col-lg-2">
            <button type="button" class="btn btn-primary" onclick="findblock(document.getElementById('getBlock').value);">Search</button>
        </div>
    </div>
    <div class="row">
        <br>
        <div class="col-lg-1">
            <button class="btn btn-primary" onclick="showselection();">Select Fields</button>
        </div>
        <div class="col-lg-1" style="margin-left:25px">
            <button class="btn btn-primary" onclick="clearselection();">Clear Selection</button><br>
        </div>
    </div>
    <div id="map"></div>
    @*<span id="messages"></span>*@

    <div class="row m-t-sm">
        <div class="col-lg-12">
            <div class="panel blank-panel">
                <div class="panel-heading">
                    <div class="panel-options">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tab-1" data-toggle="tab">Task Details</a></li>

                        </ul>
                    </div>
                </div>

                <div class="panel-body">

                    <div class="tab-content">
                        <div class="tab-pane active" id="tab-1">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Borough</th>
                                    <th>Lot </th>
                                    <th>Block</th>
                                    <th>Owner Name</th>
                                    <th>ZipCode</th>
                                    <th>BBL </th>
                                    <th>X Coord</th>
                                    <th>Y Coord</th>
                                </tr>
                                </thead>
                                <tbody id="getTableData"></tbody>
                            </table>

                        </div>

                    </div>

                </div>

            </div>
        </div>
    </div>

</body>

@section Styles {
    <style>
        #map {
            position: relative;
            margin: 5px;
            width: 1000px;
            height: 400px;
            border: 1px solid #000;
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/dijit/themes/soria/soria.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/dojox/grid/resources/Grid.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/dojox/grid/resources/soriaGrid.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/esri/css/esri.css" />

}

@section Scripts {
    <script src="https://js.arcgis.com/3.23/"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script type="text/javascript">
        var dojoConfig = { parseOnLoad: true };
        dojo.require("dijit.dijit"); // optimize: load dijit layer
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("esri.map");
        dojo.require("esri.layers.FeatureLayer");
        dojo.require("esri.symbols.SimpleFillSymbol");
        dojo.require("esri.symbols.SimpleLineSymbol");
        dojo.require("esri.toolbars.draw");
        dojo.require("dojo.data.ItemFileWriteStore");
        dojo.require("dojox.grid.DataGrid");
        dojo.require("dijit.form.Button");
        dojo.require("dojox.grid.cells.dijit");
        dojo.require("dojo.number");
        dojo.require("dijit.TooltipDialog");
        dojo.require("esri.toolbars.draw");
        dojo.require("dojo.dom");
        dojo.require("dojo.on");
        dojo.require("dojo.parser");
        dojo.require("dojo._base.array");
        dojo.require("esri.Color");
        dojo.require("dojo.number");
        dojo.require("esri.graphic");
        dojo.require("esri.geometry.Point");

        var featureLayer;
        var map;
        var selectionToolbar;
        var query;


        dojo.ready(loadinit);

        function loadinit() {
            // query = new esri.tasks.Query();
            // query.where = "Block = 1572";

            dojo.parser.parse();

            map = new esri.Map("map",
                {
                    basemap: "satellite",
                    center: [-73.90798403043057, 40.67716150820878],
                    zoom: 18
                });


            map.on("load",
                function (event) {
                    selectionToolbar = new esri.toolbars.Draw(event.map);

                });


        }


        function showTooltip(evt) {
            closeDialog();
            var dialog = new dijit.TooltipDialog({
                id: "tooltipDialog",
                content: evt.graphic.attributes.Block + "<br />" + evt.graphic.attributes.OwnerName,
                style: "position: absolute; width: 200px; font: normal normal bold 6pt Tahoma;z-index:100"
            });
            dialog.startup();

            dojo.style(dialog.domNode, "opacity", 0.85);
            dijit.placeOnScreen(dialog.domNode, { x: evt.pageX, y: evt.pageY }, ["TL", "BL"], { x: 10, y: 10 });
        }

        function closeDialog() {
            var widget = dijit.byId("tooltipDialog");
            if (widget) {
                widget.destroy();
            }
        }

        function findblock(val) {
            if (featureLayer) {
                //alert(featureLayer);
                featureLayer.clear();
            }

            var symbol = new esri.symbol.SimpleMarkerSymbol({
                "color": [255, 255, 255, 255],
                "size": 5,
                "angle": 0,
                "xoffset": 0,
                "yoffset": 0,
                "type": "esriSMS",
                "style": "esriSMSCircle",
                "transparency": 0,
                "outline": {
                    "color": [51, 159, 255, 255],
                    "width": 2,
                    "type": "esriSLS",
                    "style": "esriSLSSolid"
                }
            });

            var renderer = new esri.renderer.SimpleRenderer(symbol);

            query = new esri.tasks.Query();
            query.where = "Block =" + val;


            var fieldsSelectionSymbol =
                new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                    new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT,
                        new esri.Color([255, 0, 0]),
                        2),
                    new esri.Color([192, 192, 192, 0.5]));


            featureLayer = new esri.layers.FeatureLayer(
                "https://services3.arcgis.com/A6Zjpzrub8ESZ3c7/ArcGIS/rest/services/PLUTO_Points/FeatureServer/0",
                {
                    outFields: ["*"],
                    mode: esri.layers.FeatureLayer.MODE_SELECTION
                });

            featureLayer.setRenderer(renderer);
            var selectQuery = new esri.tasks.Query();

           

            selectionToolbar.on("DrawEnd",
                function (geometry) {
                    selectionToolbar.deactivate();
                    selectQuery.geometry = geometry;
                    selectQuery.where = query.where = "Block =" + val;
                    featureLayer.selectFeatures(selectQuery,
                        esri.layers.FeatureLayer.SELECTION_ADD,
                        function (results) {
                            var facilitiesSum = "";
                            dojo._base.array.forEach(results,
                                function (feature) { 


                                    //Compare the points here and check the checkbox
                                    //$("#getTableData").append("<tr><td>" +
                                    //    feature.attributes.Borough +
                                    //    "</td><td>" +
                                    //    feature.attributes.Lot +
                                    //    "</td><td>" +
                                    //    feature.attributes.Block +
                                    //    "</td><td>" +
                                    //    feature.attributes.OwnerName +
                                    //    "</td><td>" +
                                    //    feature.attributes.ZipCode +
                                    //    "</td><td>" +
                                    //    feature.attributes.BBL +
                                    //    "</td><td>" +
                                    //    feature.attributes.XCoord +
                                    //    "</td><td>" +
                                    //    feature.attributes.YCoord +
                                    //    "</td></tr>");

                                });
                        });

                    

                    map.graphics.add(new esri.Graphic(geometry, fieldsSelectionSymbol));

                });


            map.addLayer(featureLayer);
            featureLayer.on("mouse-over", showTooltip);
            featureLayer.on("mouse-out", closeDialog);


            featureLayer.on("load",
                function () {

                    //dojo.dom.byId('messages').innerHTML = "<i>No Selected Fields</i>";


                    featureLayer.queryFeatures(query,
                        function (featureSet) {
                            
                            for (var i = 0; i < featureSet.features.length; i++) {
                                $("#getTableData").append("<tr><td>" + "<input type=\"checkbox\">"+
                                    "</td><td>" + 
                                    featureSet.features[i].attributes.Borough +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.Lot +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.Block +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.OwnerName +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.ZipCode +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.BBL +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.XCoord +
                                    "</td><td>" +
                                    featureSet.features[i].attributes.YCoord +
                                    "</td></tr>");
                            }
                            map.centerAt(
                                new esri.geometry.Point(featureSet.features[0].attributes.POINT_X, featureSet.features[0].attributes.POINT_Y));

                            featureLayer.selectFeatures(query, esri.layers.FeatureLayer.SELECTION_NEW);
                        });

                });


            featureLayer.on("click",
                function (evt) {

                    //dojo.dom.byId('messages').innerHTML = "<b>Selected Facilities owners: " +
                    //    evt.graphic.attributes['OwnerName'] +
                    //    " </b>";
                });


        }

        function showselection() {
            selectionToolbar.activate(esri.toolbars.Draw.EXTENT);
        }

        function clearselection() {
            map.graphics.clear();
            //dojo.dom.byId('messages').innerHTML = "<i>No Selected Fields</i>";

            featureLayer.queryIds(query,
                function (objectIds) {

                    featureLayer.selectFeatures(query, esri.layers.FeatureLayer.SELECTION_NEW);
                });
        }


    </script>

}